# GitHub Copilot Instructions for Meridian Ephemeris API

## üõë MANDATORY RULES - READ FIRST

### NEVER CREATE NEW FILES - MODIFY EXISTING ONES
- Search for existing functionality before creating anything new
- Use `Ctrl+Shift+F` to search across project before coding
- Modify existing files instead of creating alternatives
- Use git branches for experimental changes, not new files

### FILE LOCATION RULES
```
ONLY modify files in these locations:
‚îú‚îÄ‚îÄ backend/app/          ‚Üê Core application code
‚îú‚îÄ‚îÄ backend/tests/        ‚Üê All test files  
‚îú‚îÄ‚îÄ backend/data/         ‚Üê JSON data files
‚îú‚îÄ‚îÄ docs/                 ‚Üê Documentation
‚îî‚îÄ‚îÄ scripts/              ‚Üê Utility scripts

NEVER create files in project root except:
- Configuration files (docker-compose.yml, etc.)
- Documentation (README.md)  
- Package files (requirements.txt, pyproject.toml)
```

### SEARCH COMMANDS TO USE FIRST
```bash
# Before any new code, run these:
find . -name "*keyword*" -type f
grep -r "function_name" backend/ --include="*.py"
git log --oneline -10  # Check recent changes
python scripts/pre-commit-check.py  # Validate structure
```

## üèóÔ∏è ARCHITECTURE PATTERNS

### API Endpoint Pattern (USE THIS TEMPLATE)
```python
from fastapi import APIRouter, HTTPException, status
from app.core.monitoring.metrics import timed_calculation
from app.api.models.schemas import YourRequestModel, YourResponseModel

router = APIRouter(prefix="/ephemeris", tags=["ephemeris"])

@router.post("/endpoint", response_model=YourResponseModel)
@timed_calculation("calculation_type")
async def endpoint(request: YourRequestModel):
    try:
        # 1. Validate input (automatic with Pydantic)
        # 2. Check cache (Redis -> Memory)
        # 3. Calculate with Swiss Ephemeris
        # 4. Cache results  
        # 5. Return with monitoring
        result = perform_calculation(request.dict())
        return YourResponseModel(success=True, data=result)
    except Exception as e:
        raise HTTPException(status_code=500, detail={"error": str(e)})
```

### Core Calculation Pattern (REQUIRED)
```python
from app.core.monitoring.metrics import timed_calculation

@timed_calculation("calculation_type")
def calculate_something(data: dict) -> dict:
    # 1. Check Redis cache first
    # 2. Check memory cache if Redis miss
    # 3. Swiss Ephemeris calculation if both miss
    # 4. Cache results in both layers
    # 5. Return with proper error handling
    pass
```

## üß™ TESTING REQUIREMENTS
- Every function needs unit tests in `backend/tests/`
- API endpoints need integration tests  
- Performance benchmarks for calculations
- >90% test coverage required
- Never create test files in root directory

## üìä MONITORING INTEGRATION
```python
# Required for all new code:
from app.core.monitoring.metrics import get_metrics
metrics = get_metrics()
metrics.record_calculation("type", duration, success)
```

## üîß SWISS EPHEMERIS INTEGRATION
- All astronomical calculations MUST use Swiss Ephemeris
- Swiss Eph files are in: `Swiss Eph Library Files/`
- Fixed star data is in: `backend/data/working_fixed_stars.json`
- Never create alternative astronomical calculation methods

## ‚ùå ANTI-PATTERNS - NEVER DO THIS
```python
# DON'T create alternatives:
# fixed_stars.py + fixed_stars_new.py ‚ùå
# test_calc.py + test_calc_v2.py ‚ùå  
# config.py + new_config.py ‚ùå
# working_data.json + api_output.json ‚ùå

# DO modify existing files: ‚úÖ
# fixed_stars.py (single source of truth)
```

## üîç PRE-CODE CHECKLIST
- [ ] Searched for existing similar functionality
- [ ] Checked if file already exists to modify
- [ ] Verified correct directory for new files
- [ ] Reviewed recent git changes
- [ ] Identified dependencies that might break
- [ ] Read CLAUDE.md for full architectural context

## üö® EMERGENCY RECOVERY
If you've created duplicate files by mistake:
1. **Stop immediately** - Don't create more files
2. **Run** `python scripts/pre-commit-check.py` to see issues
3. **Move files** to correct locations following the rules above
4. **Consolidate** duplicate functionality into single files

## üìã PERFORMANCE TARGETS
- API response time: <100ms median
- Cache hit rate: >70% 
- Test coverage: >90%
- Memory usage: <1MB per calculation

## üîó KEY FILES TO REFERENCE
- `CLAUDE.md` - Complete architectural guide
- `backend/app/main.py` - Main API entry point
- `backend/app/api/routes/ephemeris.py` - API patterns
- `backend/app/core/ephemeris/` - Core calculation logic
- `Swiss Eph Library Files/sefstars.txt` - Fixed star data reference

## üí° BEST PRACTICES
- Always use descriptive function/variable names
- Include comprehensive docstrings
- Add type hints to all functions
- Follow Python PEP 8 style guidelines
- Use async/await for I/O operations
- Cache expensive calculations
- Log errors with context
- Return structured error responses

## üèóÔ∏è ARCHITECTURE OVERVIEW

### System Components
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   FastAPI       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Core Engine     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ Swiss Ephemeris ‚îÇ
‚îÇ   (REST API)    ‚îÇ    ‚îÇ  (Calculations)  ‚îÇ    ‚îÇ  (Calculations) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       
         ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             

         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  Redis Cache     ‚îÇ             
                        ‚îÇ  (Performance)   ‚îÇ             
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             
```

### Key Directories
- `backend/app/api/` - FastAPI routes and request/response models
- `backend/app/core/ephemeris/` - Core calculation engine
- `backend/tests/` - Test suites and benchmarks
- `docs/` - MkDocs documentation site

## üîÑ INCREMENTAL MODIFICATION PROTOCOL

### When Improving Existing Features:

1. **Start with Git Status Check:**
   ```bash
   git status
   git diff
   ```

2. **Create a Feature Branch:**
   ```bash
   git checkout -b fix/specific-issue-name
   ```

3. **Modify in Place:**
   ```python
   # In existing file, mark your changes clearly:
   
   # TODO: [DATE] - Refactoring for performance improvement
   def function():  # ENHANCED: [What was improved]
       """Updated implementation with [specific improvements]."""
       pass
   ```

## üö® Critical Requirements

### Before Submitting Any Code:

1. **Performance Validation**
   ```bash
   python scripts/validate-performance.py
   ```

2. **Complete Test Suite**
   ```bash
   cd backend && python -m pytest tests/ -v
   ```

3. **API Documentation**
   ```bash
   python scripts/build-docs.py
   ```

4. **Code Quality**
   ```bash
   ruff check backend/
   ruff format backend/
   mypy backend/app/
   ```

## üîó Key Files to Study

**Before implementing new features, review:**
- `backend/app/api/routes/ephemeris.py` - API pattern examples
- `backend/app/core/ephemeris/charts/natal.py` - Calculation patterns
- `backend/tests/api/routes/test_ephemeris.py` - Testing patterns

## üÜò Getting Help

When in doubt:
1. **Search before creating**
2. **Follow existing patterns**
3. **Maintain performance standards**
4. **Test comprehensively**
5. **Document thoroughly**
6. **Use the pre-modification checklist**

### Emergency Recovery Protocol
If you've already created duplicate files or messy structure:
1. **Stop immediately**
2. **Run pre-commit checks** - `python scripts/pre-commit-check.py`
3. **Create backup branch**
4. **Consolidate systematically**

Remember: **Search first, modify existing files, never duplicate functionality!**
