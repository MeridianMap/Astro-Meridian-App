# GitHub Copilot Instructions for Meridian Ephemeris API

## ğŸ›‘ MANDATORY RULES - READ FIRST

### NEVER CREATE NEW FILES - MODIFY EXISTING ONES
- Search for existing functionality before creating anything new
- Use `Ctrl+Shift+F` to search across project before coding
- Modify existing files instead of creating alternatives
- Use git branches for experimental changes, not new files

### FILE LOCATION RULES
```
ONLY modify files in these locations:
â”œâ”€â”€ backend/app/          â† Core application code
â”œâ”€â”€ backend/tests/        â† All test files  
â”œâ”€â”€ backend/data/         â† JSON data files
â”œâ”€â”€ docs/                 â† Documentation
â””â”€â”€ scripts/              â† Utility scripts

NEVER create files in project root except:
- Configuration files (docker-compose.yml, etc.)
- Documentation (README.md)  
- Package files (requirements.txt, pyproject.toml)
```

### SEARCH COMMANDS TO USE FIRST
```bash
# Before any new code, run these:
find . -name "*keyword*" -type f
grep -r "function_name" backend/ --include="*.py"
git log --oneline -10  # Check recent changes
python scripts/pre-commit-check.py  # Validate structure
```

## ğŸš¨ COMPLEXITY & QUALITY GATES

### MANDATORY Pre-Development Checks
**Run these checks BEFORE starting any feature development:**

```bash
# 1. Complexity Gate Check
current_complexity=$(python scripts/generate-manifest.py --score-only)
if [ $current_complexity -gt 300 ]; then
    echo "âŒ COMPLEXITY GATE FAILED: $current_complexity > 300"
    echo "ğŸ›‘ REFACTOR REQUIRED before adding new features"
    exit 1
fi

# 2. Existing Implementation Search  
grep -r "similar_functionality" backend/ --include="*.py"
find . -name "*related_feature*" -type f

# 3. Response Size Baseline
python scripts/validate-performance.py --response-size-check
```

### Complexity Thresholds
- **ğŸŸ¢ HEALTHY (0-150)**: All development allowed
- **ğŸŸ¡ WARNING (151-300)**: Document decisions, review architecture  
- **ğŸŸ  DANGER (301-450)**: FEATURE FREEZE - refactor before new features
- **ğŸ”´ CRITICAL (451+)**: EMERGENCY - no new features until <300

### Response Size Requirements
**HARD LIMIT**: All API responses MUST be <50KB (except file downloads)

```python
# REQUIRED for all API endpoints:
import json

def validate_response_size(response: dict) -> dict:
    size_kb = len(json.dumps(response)) / 1024
    if size_kb > 50:
        logger.error(f"Response size {size_kb:.1f}KB exceeds 50KB limit")
        raise ValueError(f"Response too large: {size_kb:.1f}KB > 50KB limit")
    return response
```

## ğŸš« EXPLICIT TASK LIMITATIONS

### MANDATORY: State When You CANNOT Complete Tasks

**Always explicitly communicate limitations using this template:**

```
âŒ **Cannot complete this task because:**
- **Specific Limitation**: [Exact technical reason]
- **Impact**: [Why this prevents task completion]  
- **Alternative**: [What CAN be provided instead]
- **Requirements**: [What would make it possible]
```

### Common Limitations to Declare:

#### ğŸ”’ Data/File Access
```
âŒ Cannot read configuration file because:
- **Limitation**: File not provided in context
- **Impact**: Cannot verify current settings
- **Alternative**: Provide template configuration
- **Requirements**: Access to actual config file
```

#### ğŸ§® Astronomical Calculations  
```
âŒ Cannot validate Swiss Ephemeris calculations because:
- **Limitation**: No access to Swiss Ephemeris binaries or reference data
- **Impact**: Cannot ensure astronomical accuracy
- **Alternative**: Provide integration pattern for testing
- **Requirements**: Swiss Ephemeris documentation and validated outputs
```

#### ğŸ”— System Integration
```
âŒ Cannot test Redis caching integration because:
- **Limitation**: No Redis connection available
- **Impact**: Cannot verify cache behavior
- **Alternative**: Provide caching pattern and unit tests
- **Requirements**: Redis instance and connection details
```

#### ğŸ¯ Domain Expertise
```
âŒ Cannot verify traditional astrological accuracy because:
- **Limitation**: Requires specialized astrological knowledge
- **Impact**: Cannot ensure formula correctness
- **Alternative**: Provide implementation for expert review
- **Requirements**: Traditional astrology expert validation
```

### Quality Standards Through Limitations

**Never provide "might work" solutions.** Instead:

```python
# âŒ DON'T DO THIS:
def calculate_something():
    # This might work for basic calculations...
    return approximate_result()

# âœ… DO THIS:
def calculate_something():
    raise NotImplementedError(
        "Cannot complete calculation because:\n"
        "- Limitation: No access to required astronomical constants\n"
        "- Impact: Results would be inaccurate\n" 
        "- Alternative: Provide calculation pattern\n"
        "- Requirements: Validated astronomical data"
    )
```

## ğŸ—ï¸ ARCHITECTURE PATTERNS

### API Endpoint Pattern (USE THIS TEMPLATE)
```python
from fastapi import APIRouter, HTTPException, status
from app.core.monitoring.metrics import timed_calculation
from app.api.models.schemas import YourRequestModel, YourResponseModel

router = APIRouter(prefix="/ephemeris", tags=["ephemeris"])

@router.post("/endpoint", response_model=YourResponseModel)
@timed_calculation("calculation_type")
async def endpoint(request: YourRequestModel):
    try:
        # 1. Validate input (automatic with Pydantic)
        # 2. Check cache (Redis -> Memory)
        # 3. Calculate with Swiss Ephemeris
        # 4. Cache results  
        # 5. Return with monitoring
        result = perform_calculation(request.dict())
        return YourResponseModel(success=True, data=result)
    except Exception as e:
        raise HTTPException(status_code=500, detail={"error": str(e)})
```

### Core Calculation Pattern (REQUIRED)
```python
from app.core.monitoring.metrics import timed_calculation

@timed_calculation("calculation_type")
def calculate_something(data: dict) -> dict:
    # 1. Check Redis cache first
    # 2. Check memory cache if Redis miss
    # 3. Swiss Ephemeris calculation if both miss
    # 4. Cache results in both layers
    # 5. Return with proper error handling
    pass
```

## ğŸ§ª TESTING REQUIREMENTS
- Every function needs unit tests in `backend/tests/`
- API endpoints need integration tests  
- Performance benchmarks for calculations
- >90% test coverage required
- Never create test files in root directory

## ğŸ“Š MONITORING INTEGRATION
```python
# Required for all new code:
from app.core.monitoring.metrics import get_metrics
metrics = get_metrics()
metrics.record_calculation("type", duration, success)
```

## ğŸ”§ SWISS EPHEMERIS INTEGRATION
- All astronomical calculations MUST use Swiss Ephemeris
- Swiss Eph files are in: `Swiss Eph Library Files/`
- Fixed star data is in: `backend/data/working_fixed_stars.json`
- Never create alternative astronomical calculation methods

## âŒ ANTI-PATTERNS - NEVER DO THIS
```python
# DON'T create alternatives:
# fixed_stars.py + fixed_stars_new.py âŒ
# test_calc.py + test_calc_v2.py âŒ  
# config.py + new_config.py âŒ
# working_data.json + api_output.json âŒ

# DO modify existing files: âœ…
# fixed_stars.py (single source of truth)
```

## ğŸ” PRE-CODE CHECKLIST
- [ ] Searched for existing similar functionality
- [ ] Checked if file already exists to modify
- [ ] Verified correct directory for new files
- [ ] Reviewed recent git changes
- [ ] Identified dependencies that might break
- [ ] Read CLAUDE.md for full architectural context

## ğŸš¨ EMERGENCY RECOVERY
If you've created duplicate files by mistake:
1. **Stop immediately** - Don't create more files
2. **Run** `python scripts/pre-commit-check.py` to see issues
3. **Move files** to correct locations following the rules above
4. **Consolidate** duplicate functionality into single files

## ğŸ“‹ PERFORMANCE TARGETS
- API response time: <100ms median
- Cache hit rate: >70% 
- Test coverage: >90%
- Memory usage: <1MB per calculation

## ğŸ”— KEY FILES TO REFERENCE
- `CLAUDE.md` - Complete architectural guide
- `backend/app/main.py` - Main API entry point
- `backend/app/api/routes/ephemeris.py` - API patterns
- `backend/app/core/ephemeris/` - Core calculation logic
- `Swiss Eph Library Files/sefstars.txt` - Fixed star data reference

## ğŸ’¡ BEST PRACTICES
- Always use descriptive function/variable names
- Include comprehensive docstrings
- Add type hints to all functions
- Follow Python PEP 8 style guidelines
- Use async/await for I/O operations
- Cache expensive calculations
- Log errors with context
- Return structured error responses

## ğŸ—ï¸ ARCHITECTURE OVERVIEW

### System Components
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI       â”‚â”€â”€â”€â”€â”‚  Core Engine     â”‚â”€â”€â”€â”€â”‚ Swiss Ephemeris â”‚
â”‚   (REST API)    â”‚    â”‚  (Calculations)  â”‚    â”‚  (Calculations) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             

         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  Redis Cache     â”‚             
                        â”‚  (Performance)   â”‚             
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             
```

### Key Directories
- `backend/app/api/` - FastAPI routes and request/response models
- `backend/app/core/ephemeris/` - Core calculation engine
- `backend/tests/` - Test suites and benchmarks
- `docs/` - MkDocs documentation site

## ğŸ”„ INCREMENTAL MODIFICATION PROTOCOL

### When Improving Existing Features:

1. **Start with Git Status Check:**
   ```bash
   git status
   git diff
   ```

2. **Create a Feature Branch:**
   ```bash
   git checkout -b fix/specific-issue-name
   ```

3. **Modify in Place:**
   ```python
   # In existing file, mark your changes clearly:
   
   # TODO: [DATE] - Refactoring for performance improvement
   def function():  # ENHANCED: [What was improved]
       """Updated implementation with [specific improvements]."""
       pass
   ```

## ğŸš¨ Critical Requirements

### Before Submitting Any Code:

1. **Performance Validation**
   ```bash
   python scripts/validate-performance.py
   ```

2. **Complete Test Suite**
   ```bash
   cd backend && python -m pytest tests/ -v
   ```

3. **API Documentation**
   ```bash
   python scripts/build-docs.py
   ```

4. **Code Quality**
   ```bash
   ruff check backend/
   ruff format backend/
   mypy backend/app/
   ```

## ğŸ”— Key Files to Study

**Before implementing new features, review:**
- `backend/app/api/routes/ephemeris.py` - API pattern examples
- `backend/app/core/ephemeris/charts/natal.py` - Calculation patterns
- `backend/tests/api/routes/test_ephemeris.py` - Testing patterns

## ğŸ†˜ Getting Help

When in doubt:
1. **Search before creating**
2. **Follow existing patterns**
3. **Maintain performance standards**
4. **Test comprehensively**
5. **Document thoroughly**
6. **Use the pre-modification checklist**

### Emergency Recovery Protocol
If you've already created duplicate files or messy structure:
1. **Stop immediately**
2. **Run pre-commit checks** - `python scripts/pre-commit-check.py`
3. **Create backup branch**
4. **Consolidate systematically**

Remember: **Search first, modify existing files, never duplicate functionality!**
